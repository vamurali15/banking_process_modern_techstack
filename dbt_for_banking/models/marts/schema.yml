version: 2

models:
  # -------------------------------------------------------------------------
  # STAGING MODEL: stg_accounts (The latest version of each account)
  # -------------------------------------------------------------------------
  - name: stg_accounts
    description: Deduplicated, latest account record from the raw accounts data source.
    columns:
      - name: account_id
        description: Primary key for the account.
        tests:
          - unique
          - not_null
      
      - name: customer_id
        description: Foreign key link to the customer dimension.
        tests:
          - not_null
          
      - name: account_type
        description: Type of account (e.g., 'checking', 'savings').
        tests:
          # FIX: dbt CORE Test - Arguments passed directly (NO 'args' key)
          - accepted_values:
              values: ['checking', 'savings', 'loan']
                
      - name: balance
        description: Current account balance.
        tests:
          # dbt_expectations Test - Arguments MUST be under 'args' key
          - dbt_expectations.expect_column_values_to_be_of_type:
              args:
                column_type: NUMERIC
          # dbt_expectations Test - Arguments MUST be under 'args' key
          - dbt_expectations.expect_column_min_to_be_greater_than:
              args:
                min_value: -5000 
                
      - name: created_at
        description: Timestamp when the account was initially created.
        tests:
          - not_null
          
  # -------------------------------------------------------------------------
  # FACT MODEL: fct_transactions (Incremental Transactional Data)
  # -------------------------------------------------------------------------
  - name: fct_transactions
    description: Consolidated and joined transaction facts (incremental merge).
    columns:
      - name: transaction_id
        description: Primary key for the transaction.
        tests:
          - unique
          - not_null
          
      - name: account_id
        description: Foreign key to the account table.
        tests:
          - not_null
          # dbt CORE Test - Relationships must use direct parameters (NO 'args' key)
          - relationships:
              to: ref('stg_accounts')
              field: account_id
                
      - name: customer_id
        description: Customer ID derived from joining the account staging table.
        tests:
          - not_null 
          
      - name: amount
        description: Transaction amount.
        tests:
          # dbt_expectations Test - Arguments MUST be under 'args' key
          - dbt_expectations.expect_column_min_to_be_greater_than:
              args:
                min_value: -100000 
          - dbt_expectations.expect_column_max_to_be_less_than:
              args:
                max_value: 100000
                
      - name: transaction_time
        description: The time the transaction occurred.
        tests:
          - not_null